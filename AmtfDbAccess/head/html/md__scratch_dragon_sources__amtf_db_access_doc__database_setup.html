<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>AmtfDbAccess: PostgreSQL database setup for AMTF / XFEL Operational testing</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="ChimeraTK_Logo_whitebg.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">AmtfDbAccess
   &#160;<span id="projectnumber">02.09.02</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('md__scratch_dragon_sources__amtf_db_access_doc__database_setup.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">PostgreSQL database setup for AMTF / XFEL Operational testing </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The initial setup requires several steps to be taken.</p>
<h1><a class="anchor" id="autotoc_md1"></a>
Check if PostgreSQL is actually listening</h1>
<p>To do that, I have used two commands: </p><pre class="fragment">$ sudo lsof -n -u postgres | grep LISTEN
$ sudo netstat -ltnp | grep postgres
</pre><p>Both should have some input that is showing, that <code>postgresql</code> is working and listening.</p>
<h1><a class="anchor" id="autotoc_md2"></a>
Setup proper authentication</h1>
<p>The initial configuration for the database is quite restrictive. There are few changes required to make it a little bit more useful for our setup.</p>
<h2><a class="anchor" id="autotoc_md3"></a>
Change &lt;tt&gt;postgres&lt;/tt&gt; password to default (&lt;a href="https://help.ubuntu.com/stable/serverguide/postgresql.html"&gt;via Ubuntu help&lt;/a&gt;)</h2>
<pre class="fragment">$ sudo su -u postgres -i # now the proper one is `sudo su postgres`
$ psql
&gt; ALTER USER postgres with encrypted password 'postgres';
</pre><p>This solution is not very secure but sufficient for our current needs.</p>
<h2><a class="anchor" id="autotoc_md4"></a>
Setup remote access</h2>
<p>Two files need to be changed in order to allow clients from other servers to connect (<a href="http://askubuntu.com/a/423181">via AskUbuntu</a>): </p><pre class="fragment">$ sudo vim /etc/postgresql/9.5/main/pg_hba.conf # number "9.5" may change due to the version installed
## Here I am adding lines: 
local all postgres md5
host all all 0.0.0.0/0 md5

$ sudo vim /etc/postgresql/9.5/main/postgresql.conf # number "9.5" may change due to the version installed
## Here I am adding line:
listen_addresses = '*'
</pre><p>After providing changes, the service needs to be restarted: </p><pre class="fragment">$ sudo systemctl restart postgresql.service
</pre><h1><a class="anchor" id="autotoc_md5"></a>
Connecting to database</h1>
<p>We can connect by various methods. First way is to use command line: </p><pre class="fragment">$ psql -h xfelml1 -U postgres
</pre><p>Another one involves using <code>pgadmin3</code>, where you can setup the connection to <code>xfelml1</code> server. </p><pre class="fragment">$ sudo apt-get install pgadmin3
</pre><h1><a class="anchor" id="autotoc_md6"></a>
Lack of instrumentation functions</h1>
<p>The solution is provided on <a href="http://stackoverflow.com/questions/16112752/how-to-solve-postgresql-pgadmin-error-server-instrumentation-not-installed-for">StackOverflow thread</a> </p><pre class="fragment">$ sudo apt-get install postgresql-contrib
</pre><p>After installation, during connection by <code>pgadmin3</code>, it is enough to press "Fix it!" in the prompt.</p>
<h1><a class="anchor" id="autotoc_md7"></a>
Backing up the database</h1>
<pre class="fragment">#!/bin/bash
dateNow=$(date +"%Y-%m-%d")
dateNowNoDay=$(date +"%Y-%m")
if [ ! -d /home/fmak/backup/amtfDump_"$dateNowNoDay" ]; then
        mkdir /home/fmak/backup/amtfDump_"$dateNowNoDay"
fi

pg_dump -U postgres -h localhost -p 5432 AMTF_ARCHIVE_NEW &gt; /home/fmak/backup/amtfDump_"$dateNowNoDay"/amtfDump_"$dateNow"
</pre><h1><a class="anchor" id="autotoc_md8"></a>
Restoring database</h1>
<p>psql -d AMTF_ARCHIVE -U postgres -f FILENAME</p>
<p>There might be some issues with UTF-8 coding. To fix that, please remove characters that are causing an error by searching them in hexadecimal mode (<a href="http://stackoverflow.com/questions/2266383/use-vim-to-search-by-hex-code">via StackOverflow</a>): </p><pre class="fragment">    /\%xf8 
    X
</pre><p>Although that seems to solve the problem, there are still some problems with restoring the tables. It has to be done piece by piece to know what might be the issue.</p>
<h2><a class="anchor" id="autotoc_md9"></a>
Using &lt;tt&gt;.sql&lt;/tt&gt; files in &lt;tt&gt;amtfdbaccess&lt;/tt&gt; repository</h2>
<p>To build the database from scratch, it might be reasonable to use SQL queries stored in <code>database_operations</code> directory.</p>
<ul>
<li><code>databaseSchema.sql</code> stores whole database schema, without any data.</li>
<li><code>fixedDatabaseData.sql</code> stores initial data to be provided to empty database. It contains cavities, modules and relation between them, cavinmod.</li>
</ul>
<p>Also, in case you have an old instance of the database (2016 or earlier), it might make sense to run migration operations:</p>
<ul>
<li><code>001-2017-06-13.sql</code> adds <code>rf_station</code> column to <code>module</code> table</li>
<li><code>002-2017-06-13-set_rf_station.sql</code> fills <code>module.rf_station</code> column with data.</li>
</ul>
<p>It is generally a good idea to store any schema or fixed data changes both as <code>migrations</code> queries, but it would be useful to update <code>databaseSchema.sql</code> and <code>fixedDatabaseData.sql</code> files as well. In the long run, the best approach would be to have an ORM (<a href="http://docs.sqlalchemy.org/en/latest/orm/">SQLAlchemy</a>, <a href="https://github.com/rbock/sqlpp11">sqlpp11</a>), that would manage migrations and eventually map the schema to the functional code. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
