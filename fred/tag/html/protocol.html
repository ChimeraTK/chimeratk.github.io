<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>fred: The TPC communication protocol for the Fuse-Relay-Board</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="ChimeraTK_Logo_whitebg.png"/></td>
  <td id="projectalign">
   <div id="projectname">fred<span id="projectnumber">&#160;02.04.01</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('protocol.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">The TPC communication protocol for the Fuse-Relay-Board</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This is the description of protocol version 3.0.</p>
<p>The protocol is a plain-text protocol so it is human readable an can be executed from a telnet client. I is running on port 10001. The server currently does not interpret telnet command squences, so the client should not send any. Usually they are turned off for non-telnet ports by default, so no further action should be required by the user.</p>
<p>The server prints its output and ends with "# " without trailing new line. After that it waits for a new command, to which it responds. All commands are interpreted case insensitive. The camel casing in the examples and documentation improves the readability.</p>
<p>In case the answer contains more than one word, the words are separated by spaces. There is at least one space, more spaces are be added for alignment. The words always have the same width, consting of leading spaces plus the value.</p>
<p>In case a command is not recogised the response is "Unknown command". In case one or more arguments are not reconised the response is "Bad argument(s)".</p>
<p>Commands which change the power but ignore the hotplug start with "force". Commands which write to the EEPROM start with "prog" (for programme). The are for manual configuration of the board.</p>
<dl class="section note"><dt>Note</dt><dd>Do not use progXXX commands in a script which repeatedly writes them. The EEPROM has a limited number of write cycles (100k), which can be exhausted rapidly if they are written every few seconds.</dd></dl>
<h1><a class="anchor" id="comment_lines"></a>
Comment lines</h1>
<p>Comment lines allow debug, warning and error messages which can be filtered out during comminication. They start with one, two or three {FIXME} % signs, respectively.</p>
<ul>
<li><code>%</code> Indicates a debug line, always discarded by an automated client </li>
<li><code>%%</code> Indicates a warning line, the client might decide to display it. The text should start with WARNING: </li>
<li><code>%%%</code> An error line, the client might decide to throw an exception. The text should start with ERROR:</li>
</ul>
<p>In case of unexpected behaviour, the firmware shall print out 'debug' messages so a manual operator can follow what is happening and comprehend the problem. The automatic client filters these messages and must not be disturbed with changing output of debug messages.</p>
<h1><a class="anchor" id="Commands"></a>
Commands</h1>
<ul>
<li><code>readChan</code> Read the status of one channel </li>
<li><code>readAll</code> Read the statuses of all channels</li>
</ul>
<ul>
<li><code>powerOn</code> Turn on the power on all channels, respects hotplug </li>
<li><code>powerOff</code> Turn off the power on all channels, respects hotplug</li>
</ul>
<ul>
<li><code>forcePowerOn</code> Turn on the power on all channels, ignores/overrides hotplug </li>
<li><code>forcePowerOff</code> Turn off the power on all channels, ignores/overrides hotplug </li>
<li><code>forceChanOn</code> Turn one channel on, ignores/overrides hotplug </li>
<li><code>forceChanOff</code> Turn one channel off, ignores/overrides hotplug </li>
<li><code>forcePwrStates</code> Set the power on/off states for selected channels, ignores/overrides hotplug</li>
</ul>
<ul>
<li><code>readAlarms</code> Read the hardware alarms register and overcurrent alarms </li>
<li><code>clearAlarms</code> Clear the hardware and overcurrent alarms </li>
<li><code>progAlarmMasks</code> Configure which alarms should turn off which channel </li>
<li><code>readAlarmMasks</code> Read the alarm settings </li>
<li><code>readCurLimits</code> Read the current limits of all channels </li>
<li><code>progCurLimit</code> Set the current limit for individual channels</li>
</ul>
<ul>
<li><code>progHotplugMask</code> Specify which channels are treated as hotplug channels </li>
<li><code>readHotplugMask</code> Read back the hotplug channel mask </li>
<li><code>progOperationMode</code> Set the operation mode of the <a class="el" href="class_fred.html" title="This is the singleton class used by all tests to access the fred connection.">Fred</a> </li>
<li><code>readOperationMode</code> Read the operation mode of the <a class="el" href="class_fred.html" title="This is the singleton class used by all tests to access the fred connection.">Fred</a></li>
</ul>
<ul>
<li><code>TmcbReadStatus</code> Read the Tmcb status (present or absent, handle in or out, FPGA status) </li>
<li><code>TmcbSelectProm</code> Selects which program to load on the Tmcb </li>
<li><code>TmcbReloadFPGA</code> Reset the FPGA on the Tmcb </li>
<li><code>TmcbHardReset</code> Reset the TMCB by cutting the management power</li>
</ul>
<ul>
<li><code>FbReadFansInfo</code> Read speed, voltage, current and mode for all fans </li>
<li><code>FbProgFan</code> Set the speed and the operation mode of all fans </li>
<li><code>FbProgShunt</code> Programme the resistance of the shunt resistor on the fan board</li>
</ul>
<ul>
<li><code>help</code> Show a list of commands and their arguments </li>
<li><code>version</code> Read the firmware, protocol and board versions </li>
<li><code>reboot</code> Reboot the <a class="el" href="class_fred.html" title="This is the singleton class used by all tests to access the fred connection.">Fred</a> micro controller</li>
</ul>
<ul>
<li><code>progDeviceName</code> Sets the device name of the board </li>
<li><code>progInvNr</code> Sets the inventory number of the board </li>
<li><code>progChanName</code> Sets the name of a channel </li>
<li><code>fwupgrade</code> Shutdown the micro controller and wait for a firmware upgrade through the serial connection</li>
</ul>
<h2><a class="anchor" id="readChan"></a>
readChan</h2>
<p>Read the status information for one channel.</p>
<p>Syntax: <code> readChan chanNr</code> </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">chanNr</td><td>The channel number [0..7]</td></tr>
  </table>
  </dd>
</dl>
<p>Response format: </p><ul>
<li>header line <code>"chan state mV  mA name"</code><br  />
 </li>
<li>status line: <code> chanNr onOffState voltage current name</code></li>
</ul>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">chanNr</td><td>The channel number (1 digit) </td></tr>
    <tr><td class="paramname">onOffState</td><td>An 8 bit status word with the following format <ul>
<li><code>bit 0 :</code> Actual power on/off state of the channel </li>
<li><code>bit 1 :</code> Flag whether the actual power state is identical to the software configuration. </li>
<li><code>bit 2 :</code> Not used at the moment. </li>
<li><code>bit 3 :</code> Not used at the moment. </li>
<li><code>bit 4 :</code> Communication error with the power monitor. Current and voltage are set to 0. It might be that the channel has no external voltage connected. Note that this flag allows both <code>0</code> and <code>1</code> in bit <code>0</code>. </li>
<li><code>bit 5 :</code> Turned off due to hardware alarm 0. </li>
<li><code>bit 6 :</code> Turned off due to hardware alarm 1. </li>
<li><code>bit 7 :</code> Turned off due to overcurrent. </li>
</ul>
</td></tr>
    <tr><td class="paramname">voltage</td><td>The monitored voltage in mV. For convenience the voltage for the negative channels is displayed as a negative valuel. (6 digits, sign + 5) </td></tr>
    <tr><td class="paramname">current</td><td>The monitored current in mA (5 digits) </td></tr>
    <tr><td class="paramname">name</td><td>The name as configured with <code>progChanName</code> (up to 20 characters)</td></tr>
  </table>
  </dd>
</dl>
<h2><a class="anchor" id="readAll"></a>
readAll</h2>
<p>Read the status information for all channels.</p>
<p>Syntax: <code> readAll </code></p>
<p>Response format: One channel status per line, see <b> readChan </b> for the channel status format.</p>
<h2><a class="anchor" id="powerOn"></a>
powerOn</h2>
<p>Turn on the power on all channels.</p>
<p>Syntax: <code> powerOn </code></p>
<p>Response format: <code> powerStateWord </code> </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">powerStateWord</td><td>The actual power state after the power on reqest. In the example the response is 7F because the current limit of channel 7 is set to 0, so the channel is immediately switched off due to the over current alarm when after it has been switched on. {FIXME: is this realistic? Overcurrent detection takes some time.}</td></tr>
  </table>
  </dd>
</dl>
<dl class="section note"><dt>Note</dt><dd>This command respects the TMCB hotplug. Use <code>forceOn</code> to override the hotplug behaviour.</dd></dl>
<p>If the TMCB is blocking the power on {FIXME} turn on independent channels or not? This is an error condition and an error message is printed:</p>
<p><code>%%% ERROR: TMCB blocked power up!</code> Note that this is only it the TMCB is present but not allowing power on. If the TMCB is not inserted, the independent channels can be turned on and this is not an error condition.</p>
<h2><a class="anchor" id="powerOff"></a>
powerOff</h2>
<p>Turn off the power on all channels.</p>
<p>Syntax: <code> powerOff </code></p>
<p>Response format: <code> powerStateWord </code> </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">powerStateWord</td><td>The actual power state word. Should usually be 0 (unless the TMBC hotplug is blocking this action, which would indicate an error condition).</td></tr>
  </table>
  </dd>
</dl>
<dl class="section note"><dt>Note</dt><dd>This command respects the TMCB hotplug. Use <code>forceOff</code> to override the hotplug behaviour.</dd></dl>
<p>If the TMCB is blocking the power off, no channel is turned off (not even the independent channels). This is an error condition and an error message is printed:</p>
<p><code>%%% ERROR: TMCB blocked power off!</code> Note that this is only if the TMCB is present but not allowing power off. If the TMCB is not inserted, the independent channels can be turned off and this is not an error condition.</p>
<p>If hotplug channels had been on but the TMCB was not inserted (usually should not be the case, but could have been forced), all channels are turned off and a waning is printed: <code>%% WARNING: Hotplug channels have been turned off. They were turned on although no TMCB was inserted!</code></p>
<h2><a class="anchor" id="forcePowerOn"></a>
forcePowerOn</h2>
<p>Turn on the power on all channels without hotplug. However, it does not overrule alarms. Alarms have to be cleares before power can be turned on.</p>
<p>Syntax: <code> forcePowerOn </code></p>
<p>Response format: <code> powerStateWord </code> </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">powerStateWord</td><td>The actual power state after the power on reqest. In the example the response is 7F because the current limit of channel 7 is set to 0, so the channel is immediately switched off due to the over current alarm when after it has been switched on. {FIXME: is this realistic? Overcurrent detection takes some time.}</td></tr>
  </table>
  </dd>
</dl>
<dl class="section note"><dt>Note</dt><dd>This command does not respect the TMCB hotplug. It does not contact the TMCB before turning on the power.</dd></dl>
<h2><a class="anchor" id="forcePowerOff"></a>
forcePowerOff</h2>
<p>Turn off the power on all channels without hotplug.</p>
<p>Syntax: <code> forcePowerOff </code></p>
<p>Response format: <code> powerStateWord </code> </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">powerStateWord</td><td>The actual power state word.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section note"><dt>Note</dt><dd>This command does not respect the TMCB hotplug. It does not contact the TMCB before turning off the power.</dd></dl>
<h2><a class="anchor" id="forcePwrStates"></a>
forcePwrStates</h2>
<p>Set the power state defined in the <code>powerStateWord</code> for the channels defined by the <code>channelMask</code>.</p>
<p>Syntax: <code> forcePwrStates powerStateWord channelMask </code> </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">powerStateWord</td><td>An 8 bit hex word encoding the input power states for all channels. Channel 0 is at bit 0 etc. <ul>
<li>bit = 0 : channel off </li>
<li>bit = 1 : channel on</li>
</ul>
</td></tr>
  </table>
  </dd>
</dl>
<dl class="section note"><dt>Note</dt><dd>The alarm states reported by the read commands are not reflected in the powerStateWord. The bit is 0 (channel off) in case of an alarm. </dd></dl>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">channelMask</td><td>An 8 bit hex word describing for which channels the power state is changed. Channel 0 is at bit 0 etc. <ul>
<li>bit = 0 : channel state is not changed </li>
<li>bit = 1 : channel state is changed according to <code>powerStateWord</code> </li>
</ul>
</td></tr>
  </table>
  </dd>
</dl>
<p>Response format: <code> powerStateWord </code> </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">powerStateWord</td><td>The actual power states of all channels after applying the changes.</td></tr>
  </table>
  </dd>
</dl>
<p>Example: <code> forcePwrStates 23 0B </code><br  />
 The power state word 0x23 means channels 0, 1 and 5 on, all other channel off. The channel mask 0x0B means: Only apply this to channels 0, 1 and 3. Which means channels 0 and 1 are turned on, channel 3 is turned off, and all other channels remain unchanged.<br  />
 In the example below the channel power states of the <code>readAll</code> command correspond to a <code>powerStateWord</code> 0x5B. After applying the changes the response is 0x57.</p>
<dl class="section note"><dt>Note</dt><dd>This command does not respect the TMCB hotplug. It is not possible to come up with a consistent hot-plug scheme if not all channels are switched either on or off at the same time.</dd></dl>
<h2><a class="anchor" id="forceChanOn"></a>
forceChanOn</h2>
<p>Turn one channel on.</p>
<p>Syntax: <code> forceChanOn chanNr </code> </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">chanNr</td><td>The channel number [0..7] to be turned on.</td></tr>
  </table>
  </dd>
</dl>
<p>Response format: <code> powerStateWord </code> </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">powerStateWord</td><td>The power state word for all channels</td></tr>
  </table>
  </dd>
</dl>
<dl class="section note"><dt>Note</dt><dd>This command does not respect the TMCB hotplug!</dd></dl>
<h2><a class="anchor" id="forceChanOff"></a>
forceChanOff</h2>
<p>Turn one channel off.</p>
<p>Syntax: <code> forceChanOff chanNr </code> </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">chanNr</td><td>The channel number [0..7] to be turned off.</td></tr>
  </table>
  </dd>
</dl>
<p>Response format: <code> powerStateWord </code> </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">powerStateWord</td><td>The power state word for all channels</td></tr>
  </table>
  </dd>
</dl>
<dl class="section note"><dt>Note</dt><dd>This command does not respect the TMCB hotplug!</dd></dl>
<h2><a class="anchor" id="readCurLimits"></a>
readCurLimits</h2>
<p>Read the current limits for all channels.</p>
<p>Syntax: <code> readCurLimits </code></p>
<p>Response format: <code> chanNr currentLimit </code><br  />
One line per channel </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">chanNr</td><td>The channel number (1 digit) </td></tr>
    <tr><td class="paramname">currentLimit</td><td>The current limit in mA (5 digits)</td></tr>
  </table>
  </dd>
</dl>
<h2><a class="anchor" id="progCurLimit"></a>
progCurLimit</h2>
<p>Set the current limit for one channel.</p>
<p>Syntax: <code> progCurLimit chanNr currentLimit </code> </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">chanNr</td><td>The channel number </td></tr>
    <tr><td class="paramname">currentLimit</td><td>The current limit to be set</td></tr>
  </table>
  </dd>
</dl>
<p>Response format: <code> currentLimit </code> </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">currentLimit</td><td>The actually set current limit </td></tr>
  </table>
  </dd>
</dl>
<dl class="section note"><dt>Note</dt><dd>A maximum current limit value of 10,000&#160;mA is hard coded to protect the relays, which can switch up to 10&#160;A. This is why in the example below the request to set the currentl limit of channel 5 to 30,000&#160;mA results in a response of 10000.</dd></dl>
<h2><a class="anchor" id="progHotplugMask"></a>
progHotplugMask</h2>
<p>Specify which channels are treated as hotplug channels</p>
<p>Syntax: <code> progHotplugMask hotplugMask </code></p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">hotplugMask</td><td>An 8 bit hex word encoding whether a channel is in hotplug or independent mode. Channel 0 is at bit 0 etc. <ul>
<li>bit = 0 : channel is independent </li>
<li>bit = 1 : channel is a hotplug channel </li>
</ul>
</td></tr>
  </table>
  </dd>
</dl>
<p>Response format: <code> hotplugMask </code> </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">hotplugMask</td><td>The hotplug configuration mask which has just been put in.</td></tr>
  </table>
  </dd>
</dl>
<h2><a class="anchor" id="readHotplugMask"></a>
readHotplugMask</h2>
<p>Read back the hotplug channel configuration mask.</p>
<p>Syntax: <code> readHotplugMask </code></p>
<p>Response format: <code> hotplugMask </code> </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">hotplugMask</td><td>The hotplug configuration mask as described in progHotplugMask</td></tr>
  </table>
  </dd>
</dl>
<h2><a class="anchor" id="progOperationMode"></a>
progOperationMode</h2>
<p>Set the operation mode of the <a class="el" href="class_fred.html" title="This is the singleton class used by all tests to access the fred connection.">Fred</a></p>
<p>Syntax: <code> progOperationMode mode <code></code></code></p>
<p><code><code></p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">mode</td><td>Valid modes are <ul>
<li><code>t</code> : <b>T</b>MCB mode. Perform hotplug handshakes with the TMCB. </li>
<li><code>s</code> : <b>S</b>tand alone mode. Do not talk to the TMCB and ignore hotplug settings. </li>
<li><code>j</code> : Hardware <b>J</b>umper determines the operation mode (closed: TMCB mode, open: stand alone mode) </li>
</ul>
</td></tr>
  </table>
  </dd>
</dl>
<p></code></code></p>
<p><code><code></code></code></p>
<p><code><code></code></code></p>
<p><code><code>Response format: see readOperationMode</code></code></p>
<p><code><code></code></code></p>
<h2><a class="anchor" id="readOperationMode"></a>
readOperationMode</h2>
<p><code><code></code></code></p>
<p><code><code>Syntax: <code> readOperationMode <code></code></code></code></code></p>
<p><code><code><code><code>Response format: </p><ul>
<li>comment line: "% [TMCB/Standalone] mode configured by [jumper/software]" </li>
<li>status line: <code> operationModeWord </code></li>
</ul>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">operationModeWord</td><td>A 4 bit hex word (one 'digit') <ul>
<li><code>bit 0 :</code> 1 = TMCB mode (hotplug on), 0 = standalone mode (hotplug off) </li>
<li><code>bit 1 :</code> 0 = jumper is determining mode, 1 = software is determining mode </li>
<li><code>bit 2 and 3 :</code> not used at the moment </li>
</ul>
</td></tr>
  </table>
  </dd>
</dl>
<p></code></code></code></code></p>
<p><code><code><code><code></code></code></code></code></p>
<p><code><code><code><code></code></code></code></code></p>
<p><code><code><code><code>The bit field was chosen as return value because it is easy to parse programmatically. As the bit field is difficult to decypher manually, a comment line with plain text is added.</code></code></code></code></p>
<p><code><code><code><code></code></code></code></code></p>
<h2><a class="anchor" id="progAlarmMasks"></a>
progAlarmMasks</h2>
<p><code><code><code><code> Configure which channels should turn off in case of an alarm either due to overcurrent or a signal on the hardware alarm pins 0 and 1. The alarm masks are 8 bit hex values configuring whether the alarm is active for the specific channels [0..7] </p><ul>
<li>bit n = 0 : alarm on channel n is off </li>
<li>bit n = 1 : alarm on channel n is active</li>
</ul>
<p>Syntax: <code> progAlarmMasks overcurrentAlarmMask pin0AlarmMask pin1AlarmMask </code> </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">overcurrentAlarmMask</td><td>Configures which channels are turned of if the channel specific current is exceeded (see progCurLimit). </td></tr>
    <tr><td class="paramname">pin0AlarmMask/pin1AlarmMask</td><td>Configures which channels are turned off if an alarm is signaled on alarm pins 0 and 1, respectively.</td></tr>
  </table>
  </dd>
</dl>
<p>Response format: <code> overcurrentAlarmMask pin0AlarmMask pin1AlarmMask </code></code></code></code></code></p>
<p><code><code><code><code></code></code></code></code></p>
<h2><a class="anchor" id="readAlarmMasks"></a>
readAlarmMasks</h2>
<p><code><code><code><code> Read back the alarms masks.</code></code></code></code></p>
<p><code><code><code><code>Syntax: <code> readAlarmMasks </code></code></code></code></code></p>
<p><code><code><code><code>Response format: </p><ul>
<li>header line <code>"overcurrentAlarmMask pin0AlarmMask pin1AlarmMask"</code><br  />
 </li>
<li>status line <code> overcurrentAlarmMask pin0AlarmMask pin1AlarmMask </code></li>
</ul>
<p></code></code></code></code></p>
<h2><a class="anchor" id="readAlarms"></a>
readAlarms</h2>
<p><code><code><code><code> Read the hardware alarms register (alarm pins 0 and 1). The overcurrent alarm is a channel specific alarm generated in the micro controler and not part of this regsiter.</code></code></code></code></p>
<p><code><code><code><code>Syntax: <code> readAlarms </code></code></code></code></code></p>
<p><code><code><code><code>Response format: </p><ul>
<li>header line <code>"harwareAlarms overcurretAlarms"</code><br  />
 </li>
<li>status line <code>harwareAlarmWord overcurretAlarmWord</code></li>
</ul>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">harwareAlarmWord</td><td>8 bit hex word. The bits 0 and 1 are active if the alarm pins 0 or 1 have been triggered, respectively. </td></tr>
    <tr><td class="paramname">overcurretAlarmWord</td><td>8 bit hex word. Each bit indicates the overcurrent alarm of the channels 0 to 7.</td></tr>
  </table>
  </dd>
</dl>
<p>To reset the alarms flags use <code>clearAlarms</code>.</code></code></code></code></p>
<p><code><code><code><code></code></code></code></code></p>
<h2><a class="anchor" id="clearAlarms"></a>
clearAlarms</h2>
<p><code><code><code><code> Clear the hardware alarms register (alarm pins 0 and 1) and the overcurrent alarm flags. The response is 0 if the alarm could be cleared. If the alarm is still present at the alarm pin, the register will not be cleared and the updated alarm state will be returned. Overcurrent alarms can always be cleared as the cannel is of the overcurrent cannot be persistent.</code></code></code></code></p>
<p><code><code><code><code>Syntax: <code> clearAlarms </code></code></code></code></code></p>
<p><code><code><code><code>Response format: </p><ul>
<li>header line <code>"harwareAlarms overcurretAlarms"</code><br  />
 </li>
<li>status line <code>harwareAlarmWord overcurretAlarmWord</code></li>
</ul>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">harwareAlarmWord</td><td>8 bit hex word. 0 if clearing was successful. The bits 0 and 1 are active if the alarm pins 0 or 1 are still active, respectively. </td></tr>
    <tr><td class="paramname">overcurretAlarmWord</td><td>8 bit hex word. Should always be 0 as overcurrent conditions are not persistent because the channel is turned off.</td></tr>
  </table>
  </dd>
</dl>
<p>Example: <code>readAlarms</code> returned 03 00 (both hardware alarms are triggered). A subsequent <code>clearAlarms</code> returns 02 00, which means alarm pin 1 is still active, while pin 0 is not.</code></code></code></code></p>
<p><code><code><code><code> </p><dl class="todo"><dt><b><a class="el" href="todo.html#_todo000001">Todo:</a></b></dt><dd>TmcbSelectProm Review what has been witten down. Was not exactly clear on all the details </dd></dl>
<p></code></code></code></code></p>
<h2><a class="anchor" id="TmcbSelectProm"></a>
TmcbSelectProm</h2>
<p><code><code><code><code> Command can be used to select the program to load on the tmcb fpga board</code></code></code></code></p>
<p><code><code><code><code> Syntax: <code>TmcbSelectProm value</code></code></code></code></code></p>
<p><code><code><code><code></p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">value</td><td>Prom value can be 0 or 1. For all other values "Bad argument(s)" is returned.</td></tr>
  </table>
  </dd>
</dl>
<p>Response format: <code>promSelectionStatus</code> </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">promSelectionStatus</td><td>8 bit hex value indicating the selected prom or error. <ul>
<li><code>00</code> : Prom 0 selected </li>
<li><code>01</code> : Prom 1 selected </li>
<li><code>F0</code> : Error while selecting prom. Prom 0 active. </li>
<li><code>F0</code> : Error while selecting prom. Prom 1 active.</li>
</ul>
In case of an error, an additional %%% ERROR message will be displayed with specifics on the type of error. </td></tr>
  </table>
  </dd>
</dl>
<p></code></code></code></code></p>
<p><code><code><code><code></code></code></code></code></p>
<h2><a class="anchor" id="TmcbReloadFPGA"></a>
TmcbReloadFPGA</h2>
<p><code><code><code><code> Resets the FPGA on the the tmcb board</code></code></code></code></p>
<p><code><code><code><code> Syntax: <code>TmcbReloadFPGA</code></code></code></code></code></p>
<p><code><code><code><code> Response format: <code>fpgaRebootErrorFlags</code> </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">fpgaRebootErrorFlags</td><td>8 bit hex word errors when rebooting the FPGA. An additional % debug or %%% ERROR message will be displayed to indicate <ul>
<li>No error "% OK" </li>
<li><code>bit</code> 0 : TMCB communication error (no TMCB) "%%% ERROR Could not communicate with TMCB" </li>
<li><code>bit</code> 1 : No payload power "%%% ERROR No payload power on the TMCB" </li>
<li><code>bit</code> 2- 7 : Not used at the moment </li>
</ul>
</td></tr>
  </table>
  </dd>
</dl>
<p></code></code></code></code></p>
<p><code><code><code><code></code></code></code></code></p>
<h2><a class="anchor" id="TmcbReadStatus"></a>
TmcbReadStatus</h2>
<p><code><code><code><code> Read the TMCB status (present or absent, handle in or out, FPGA status)</code></code></code></code></p>
<p><code><code><code><code> Indicates if the tmcb board fpga is booted up or not. The command checks for the DONE_N signal from the tmcb board to know the status of the fpga.</code></code></code></code></p>
<p><code><code><code><code> Syntax: <code>TmcbReadStatus</code></code></code></code></code></p>
<p><code><code><code><code> Response format: </p><ul>
<li>header line: "present handleIn FpgaOK errorFlags" </li>
<li>status line: <code>presenseStatus handleStatus FpgaStatus errorFlags</code></li>
</ul>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">presenseStatus</td><td>1 character hex, 0 = TMCB absent, 1 = TMCB present </td></tr>
    <tr><td class="paramname">handleStatus</td><td>1 character hex, 0 = hotplug handle out, 1 = hotplug handle in (0 if not present) </td></tr>
    <tr><td class="paramname">FpgaStatus</td><td>1 character hex, 0 = FPGA not booted, 1 = FPGA booted (0 if not present) </td></tr>
    <tr><td class="paramname">errorflags</td><td>An 8 bit hex word (two 'digits') inicating errors, warnings and problems. 0 means no error, 1 means error status detected <ul>
<li><code>bit 0 :</code> Backplane EEPROM not programmed </li>
<li><code>bit 1 :</code> Will block hotplug power on </li>
<li><code>bit 2 :</code> Will block hotplug power off </li>
<li><code>bits 3 to 7 :</code> Not used at the moment. </li>
</ul>
</td></tr>
  </table>
  </dd>
</dl>
<p></code></code></code></code></p>
<p><code><code><code><code></code></code></code></code></p>
<p><code><code><code><code></code></code></code></code></p>
<p><code><code><code><code></p><dl class="section note"><dt>Note</dt><dd>Having four words instead of a large bit field is a compromise between human and machine readability. Error flags might me printed as debug comments.</dd></dl>
<p></code></code></code></code></p>
<h2><a class="anchor" id="TmcbHardReset"></a>
TmcbHardReset</h2>
<p><code><code><code><code> Reset the TMCB by cutting the management power</code></code></code></code></p>
<p><code><code><code><code> Syntax: <code>TmcbHardReset </code></code></code></code></code></p>
<p><code><code><code><code> The command ends by executing a TmcbReadStatus after the management power has been turned back on.</code></code></code></code></p>
<p><code><code><code><code> </p><dl class="todo"><dt><b><a class="el" href="todo.html#_todo000002">Todo:</a></b></dt><dd>What about the FPGA status. It will need some time to reboot...</dd></dl>
<p></code></code></code></code></p>
<p><code><code><code><code> Response format: see TmcbReadStatus</code></code></code></code></p>
<p><code><code><code><code></code></code></code></code></p>
<h2><a class="anchor" id="FbProgShunt"></a>
FbProgShunt</h2>
<p><code><code><code><code> Programme the resistance of the shunt resistor on the fan board.</code></code></code></code></p>
<p><code><code><code><code> Syntax: <code> FbProgShunt resistance </code></code></code></code></code></p>
<p><code><code><code><code></p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">resistance</td><td>Resistance of the shunt resistor in mOhms.</td></tr>
  </table>
  </dd>
</dl>
<p></code></code></code></code></p>
<h2><a class="anchor" id="FbProgFan"></a>
FbProgFan</h2>
<p><code><code><code><code> Set the operation mode and the speed of all fans.</code></code></code></code></p>
<p><code><code><code><code> Syntax: <code> FbProgFan mode speed </code></code></code></code></code></p>
<p><code><code><code><code></p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">mode</td><td>One of the two modes <ul>
<li>'R/r' Rpm mode: speed argument is treated as a uint16_t rpm value </li>
<li>'V/v' Voltage mode: Fan is in voltage mode, which means a fixed voltage is applied, but the actual speed is not monitored or controlled. The speed parameter ranges from 0 (0 V) to 255 (max. voltage = FIXME V).</li>
</ul>
</td></tr>
    <tr><td class="paramname">speed</td><td>Fan speed either as range parameter [0..255] in voltage mode, or RPMs in rotation speed mode</td></tr>
  </table>
  </dd>
</dl>
<p></code></code></code></code></p>
<p><code><code><code><code></code></code></code></code></p>
<p><code><code><code><code> Response format: String indicating bad argument if the input parameters are not as expected</code></code></code></code></p>
<p><code><code><code><code> </p><dl class="todo"><dt><b><a class="el" href="todo.html#_todo000003">Todo:</a></b></dt><dd>FIXME "a string" is not a proper, automatically parsable output format. Define a response.</dd></dl>
<p></code></code></code></code></p>
<p><code><code><code><code></code></code></code></code></p>
<h2><a class="anchor" id="FbReadFansInfo"></a>
FbReadFansInfo</h2>
<p><code><code><code><code> Read speed, voltage, current and mode of all fans.</code></code></code></code></p>
<p><code><code><code><code> Syntax: <code> FbReadFansInfo </code></code></code></code></code></p>
<p><code><code><code><code> response format: </p><ul>
<li>header line <code>"fan mode alarm mV  mA targetRPM monitorRPM"</code><br  />
 </li>
<li>status line: <code> fanNr mode alarmBit voltage current targetSpeed actualSpeed</code> <dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">fanNr</td><td>The fan number [0..2] </td></tr>
    <tr><td class="paramname">mode</td><td>The fan mode (0 = off, 1 = on, V = voltage mode, R = RPM mode) </td></tr>
    <tr><td class="paramname">alarmBit</td><td>1 if there is an alarm, 0 otherwise </td></tr>
    <tr><td class="paramname">voltage</td><td>Fan voltage in mV </td></tr>
    <tr><td class="paramname">current</td><td>Monitored current in mA </td></tr>
    <tr><td class="paramname">targetSpeed</td><td>The target speed in RPM. 0 in voltage mode </td></tr>
    <tr><td class="paramname">actualSpeed</td><td>The measured speed in RPM. 0 in voltage mode</td></tr>
  </table>
  </dd>
</dl>
</li>
</ul>
<p></code></code></code></code></p>
<h2><a class="anchor" id="help"></a>
help</h2>
<p><code><code><code><code> Show a list of all commands and their parameters.</code></code></code></code></p>
<p><code><code><code><code>Syntax: <code> help </code></code></code></code></code></p>
<p><code><code><code><code>Response format: see example below</code></code></code></code></p>
<p><code><code><code><code></p><dl class="section note"><dt>Note</dt><dd>The 'fwupgrade' command is intentionally not displayed in the help. It is not intended for interactive use and dangerous because it leaves the system in a vulnerable state where incoming data is interpreted as firmware to be written into the flash memory.</dd></dl>
<p></code></code></code></code></p>
<h2><a class="anchor" id="progDeviceName"></a>
progDeviceName</h2>
<p><code><code><code><code> This command can be used to provide a device name to the FRED board</code></code></code></code></p>
<p><code><code><code><code> Syntax: <code>progDeviceName deviceName</code></code></code></code></code></p>
<p><code><code><code><code></p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">deviceName</td><td>The parameter indicates the name of the device. The name can be 63 charachters long [0..9a..zA..Z_]</td></tr>
  </table>
  </dd>
</dl>
<p>Response format: The (truncated) name which has just been set.</code></code></code></code></p>
<p><code><code><code><code></code></code></code></code></p>
<h2><a class="anchor" id="progInvNr"></a>
progInvNr</h2>
<p><code><code><code><code> Sets an inventory number for the device</code></code></code></code></p>
<p><code><code><code><code> Syntax: <code>progInvNr inventoryNumber</code></code></code></code></code></p>
<p><code><code><code><code></p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">inventoryNumber</td><td>String containing a 63 charachter long inventory number for the board [0..9a..zA..Z_]. Longer names are truncated.</td></tr>
  </table>
  </dd>
</dl>
<p></code></code></code></code></p>
<p><code><code><code><code></code></code></code></code></p>
<p><code><code><code><code> Response format: The (truncated) name which has just been set.</code></code></code></code></p>
<p><code><code><code><code></code></code></code></code></p>
<h2><a class="anchor" id="progChanName"></a>
progChanName</h2>
<p><code><code><code><code> Sets the name of a channel and writes it to the micro controller's EEPROM</code></code></code></code></p>
<p><code><code><code><code> Syntax: <code>progChanName chanNr name</code></code></code></code></code></p>
<p><code><code><code><code></p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">chanNr</td><td>The channel number [0..7] </td></tr>
    <tr><td class="paramname">name</td><td>The channel name. A string up to 20 characters long [0..9a..zA..Z_]</td></tr>
  </table>
  </dd>
</dl>
<p>If the string is longer than 20 characters, it is truncated.</code></code></code></code></p>
<p><code><code><code><code> </code></code></code></code></p>
<p><code><code><code><code></code></code></code></code></p>
<p><code><code><code><code> Response format: The actual, truncated name which has been set.</code></code></code></code></p>
<p><code><code><code><code></code></code></code></code></p>
<h2><a class="anchor" id="getChanNames"></a>
getChanNames</h2>
<p><code><code><code><code> Read back the names of all channels</code></code></code></code></p>
<p><code><code><code><code> Syntax <code>&lt;getChanNames/tt&gt;</code></code></code></code></code></p>
<p><code><code><code><code><code> </code></code></code></code></code></p>
<p><code><code><code><code><code></code></code></code></code></code></p>
<p><code><code><code><code><code> Response format: <code> chanNr chanName </code><br  />
 One line per channel </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">chanNr</td><td>The channel number (1 digit) </td></tr>
    <tr><td class="paramname">chanName</td><td>The channel name (up to 20 characters)</td></tr>
  </table>
  </dd>
</dl>
<p></code></code></code></code></code></p>
<h2><a class="anchor" id="version"></a>
version</h2>
<p><code><code><code><code><code> Read the firmware versions of the micro processor and the CPLD chip. Also displays the UUID, configured board name and board inventory number</code></code></code></code></code></p>
<p><code><code><code><code><code> Syntax: <code> version </code></code></code></code></code></code></p>
<p><code><code><code><code><code> Response format: This is a multi-line printout </p><ul>
<li><code>Firmware: processorFirmwareVersion CPLD cpldFirmwarenVersion </code> </li>
<li><code>UUID: uuid</code> </li>
<li><code>Device name: deviceName</code> </li>
<li><code> Inventory number: inventoryNumber</code> </li>
<li><code>Board revision: revision</code> </li>
<li><code>Protocol version: protocolVersion</code></li>
</ul>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">processorFirmwareVersion</td><td>Firmware version of the microcprocessor, free text string<ul>
<li>For tags the string is the tag name, for instance \t 00.02.01, but could also be <code>tmcbHotPlugTestJune2016</code>.</li>
<li>For the trunk versions will be reported as trunk_rxxx, where xxx is taken from svnversion. It might be 1234..1237M in case of stuff not committed.</li>
<li>For braches, it will be branchname_rxxx </li>
</ul>
</td></tr>
    <tr><td class="paramname">cpldFirmwarenVersion</td><td>Firmware version of the CPLD (8 bit hex with 0x indicator, e.g. 0x20) </td></tr>
    <tr><td class="paramname">uuid</td><td>Unique identifier of the <a class="el" href="class_fred.html" title="This is the singleton class used by all tests to access the fred connection.">Fred</a> board (if present, else 00-00-00-00-00-00) </td></tr>
    <tr><td class="paramname">deviceName</td><td>Name of the board configured through progDeviceName (FIXME default = ?) </td></tr>
    <tr><td class="paramname">inventoryNumber</td><td>Inventory number of the board configured through progInvNr </td></tr>
    <tr><td class="paramname">revision</td><td>Hardware revision of the board, <code>UNKNOWN</code> of not detectable </td></tr>
    <tr><td class="paramname">protocolVersion</td><td>M.m (Major.minor), version of this protocol. All minors guarantee backward compatibility within the same version number, which means on old client can talk to a newer <a class="el" href="class_fred.html" title="This is the singleton class used by all tests to access the fred connection.">Fred</a>.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section note"><dt>Note</dt><dd>There will be a script which replaces the version in the source code before compilation.</dd></dl>
<p></code></code></code></code></code></p>
<h2><a class="anchor" id="reboot"></a>
reboot</h2>
<p><code><code><code><code><code> Reboot the <a class="el" href="class_fred.html" title="This is the singleton class used by all tests to access the fred connection.">Fred</a> micro controller. You will see the boot messages and finally get a new prompt. No defined response format.</code></code></code></code></code></p>
<p><code><code><code><code><code></code></code></code></code></code></p>
<h2><a class="anchor" id="fwupgrade"></a>
fwupgrade</h2>
<p><code><code><code><code><code> Shuts down the micro controller and tells the boot loader not to reload the firmware, but to wait for new firmware to be played in through the serial interface.</code></code></code></code></code></p>
<p><code><code><code><code><code></p><dl class="section warning"><dt>Warning</dt><dd>To not use this command manually! It is intended for use with the remote update script only.</dd></dl>
<p></code></code></code></code></code></p>
<h1><a class="anchor" id="Example"></a>
Example</h1>
<p><code><code><code><code><code></code></code></code></code></code></p>
<p><code><code><code><code><code> </p><dl class="todo"><dt><b><a class="el" href="todo.html#_todo000004">Todo:</a></b></dt><dd>There are way too many commands to make an exhaustice example. This example is for standalone mode (?). </dd></dl>
<pre class="fragment"># readChan 0
chan state mV  mA
0 01  15030  1234

# readAll
chan state mV  mA
0 01  15030  1234
1 00      0     3
2 01  15020  7234
3 01   6950   123
4 01 -14987  1243
5 80     30     1
6 01   7010   234
7 00      0     0

# forcePwrStates 23 0B
57

#forceChanOn 3
5F

#forceChanOff 4
4F

# readCurLimits
0  1500
1   500
2  8000
3   150
4  1500
5    50
6   300
7     0

# progCurLimit 5 30000
10000

# powerOn
7F

# powerOff
0

# readAlarmMasks
FF 00 3C

# progAlarmMasks 7F FF 3C
7F FF 3C

# readAlarms
02

# clearAlarms
00

# FbProgFan 1 2 2500
02

# FbReadFansInfo
fan mode alarm mV  mA targetRPM monitorRPM
0 1 0 12000   317     0     0
1 2 1 10234   417  2500  2489
2 0 0     0     0     0     0

# version
Firmware: 28.19 CPLD 0x20
UUID: 00-1E-C0-FC-C7-AB
Device name: FRED_3M_STANDARD
Inventory number: 0000
Board revision: UNKNOWN
Protocol version: 3.0

# help
readChan chanNr
readAll

powerOn
powerOff

forcePowerOn
forcePowerOff
forceChanOn chanNr
forceChanOff chanNr
forcePwrStates powerStateWord channelMask

readAlarms
clearAlarms
progAlarmMasks overcurrentAlarmMask pin0AlarmMask pin1AlarmMask
readAlarmMasks
progCurLimit chanNr currentLimit
readCurLimits

progHotplugMask hotplugMask
readHotplugMask
progOperationMode [j-HWjumper, t-TmcbMode, s-StandaloneMode]
readOperationMode

TmcbReadStatus
TmcbSelectProm promNr
TmcbReloadFPGA
TmcbHardReset

FbReadFansInfo
FbProgFan mode speed
FbProgShunt resistance

help
version
reboot

progDeviceName
progInvNr
progChanName</pre><p> </code></code></code></code></code></p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Sat Jul 26 2025 18:05:07 for fred by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
