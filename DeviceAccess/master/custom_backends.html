<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ChimeraTK-DeviceAccess: Using and creating custom backends</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="ChimeraTK_Logo_whitebg.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">ChimeraTK-DeviceAccess
   &#160;<span id="projectnumber">master</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('custom_backends.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Using and creating custom backends </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="writing_dummies"></a>
Writing Dummies: Extending the DummyBackend</h1>
<p>Extending the DummyBackend might be usefull for writing simple automated tests. For more complicated tests, in particular those needing to simulate physical behaviour, it is recommended to use the VirtualLab library.</p>
<h1><a class="anchor" id="plugin_mechanism"></a>
The Plugin Mechanism</h1>
<p>Custom backends are provided as shared libraries. There is a plugin mechanism which allows to load the backend at run time. Like this you can for instance load all kinds of backends in QtHardMon, although it has not been linked against it.</p>
<h2><a class="anchor" id="loading_backends"></a>
Loading custom backends</h2>
<p>Custom backends should be loaded in the dmap file using the <code>@LOADLIB</code> keyword, followed by the full path to the .so file with the backend.</p>
<pre class="fragment">@LOAD_LIB /path/to/your/build_directory/lib/libCustomBackend.so

MY_CUSTOM_DEVICE (CUSTOM?map=my_device.map)
</pre><p>Example dmap file from the custom backend registration example (see examples/custom_backend_registration in your build directory).</p>
<h2><a class="anchor" id="writing_backends"></a>
Writing your own backed</h2>
<p>The backend has to fulfil a few requirements for the plugin mechanism to work.</p>
<ul>
<li>The backend has to provide a createInstance() function which can be given to the BackendFactory. Like this the factory can create the backend without knowing the details how to call the specific constructor. </li>
<li>The backend has to be registered with the factory. This should automatically happen when the library is loaded. </li>
<li>The library should be loadable at run time, not only at link time. This requires to check that the backend has been compiled with the the correct DeviceAcces version.</li>
</ul>
<p>The <a class="el" href="class_custom_backend.html">CustomBackend</a> example shows how to implement those three steps of the plugin mechanism. </p><div class="fragment"><div class="line"><span class="preprocessor">#include &lt;ChimeraTK/BackendFactory.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;ChimeraTK/DeviceAccessVersion.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;ChimeraTK/DummyBackend.h&gt;</span> <span class="comment">// Would probably be DeviceBackendImpl or NumericAddressedBackend in a real application</span></div><div class="line"><span class="preprocessor">#include &lt;boost/make_shared.hpp&gt;</span></div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * A custom backend which is registered to the factory.</span></div><div class="line"><span class="comment"> * This example only shows how to register a new type of backend to the factory.</span></div><div class="line"><span class="comment"> * It does not show how to write a new backend. We are lazy and derrive from</span></div><div class="line"><span class="comment"> * DummyBackend to have a fully working backend. In a real example you would</span></div><div class="line"><span class="comment"> * either derrive from DeviceBackendImpl or NumericAddressedBackend, unless you</span></div><div class="line"><span class="comment"> * want to write a custom dummy for testing.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * Custom backends are always created as a shared library which can be loaded at</span></div><div class="line"><span class="comment"> * run time.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">class </span><a class="code" href="class_custom_backend.html">CustomBackend</a> : <span class="keyword">public</span> <a class="code" href="class_chimera_t_k_1_1_dummy_backend.html">ChimeraTK::DummyBackend</a> {</div><div class="line"> <span class="keyword">public</span>:</div><div class="line">  <span class="comment">// C++11 shorthand syntax that we want a constructor with the same parameters</span></div><div class="line">  <span class="comment">// as the parent class.</span></div><div class="line">  <span class="keyword">using</span> <a class="code" href="class_chimera_t_k_1_1_dummy_backend.html#aac7a59f55e0d319040feb3ef4be27b7a">ChimeraTK::DummyBackend::DummyBackend</a>;</div><div class="line"></div><div class="line">  <span class="comment">/*</span></div><div class="line"><span class="comment">   * You have to implement a static function createInstance() with this exact</span></div><div class="line"><span class="comment">   * signature. This function is later given to the BackendFactory to create</span></div><div class="line"><span class="comment">   * this type of backend when it is requested.</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="keyword">static</span> boost::shared_ptr&lt;ChimeraTK::DeviceBackend&gt; <a class="code" href="class_custom_backend.html#ad91973dd7ec0803f9bc7ed0b552631db">createInstance</a>(std::string <span class="comment">/*address*/</span>,</div><div class="line">      std::map&lt;std::string, std::string&gt;</div><div class="line">          parameters) {</div><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">     * Inside createInstance the parameters are interpreted and passed on to the</span></div><div class="line"><span class="comment">     * constructor. Like this the backend constructor can have arbitrary</span></div><div class="line"><span class="comment">     parameters</span></div><div class="line"><span class="comment">     * while the factory can always call a function with the same signature.</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">     * In this example we have to convert the &quot;map&quot; parameter to an absolute</span></div><div class="line"><span class="comment">     path</span></div><div class="line"><span class="comment">     * (there is already a function for it in the DummyBackend parent class),</span></div><div class="line"><span class="comment">     * and pass it on to the constructor, which has the same signature as</span></div><div class="line"><span class="comment">     DummyBackend</span></div><div class="line"><span class="comment">     * (see &#39;using&#39; clause above).</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * This part will vary, depending on the requirements of the particular</span></div><div class="line"><span class="comment">     backend.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    std::string absolutePath = <a class="code" href="class_chimera_t_k_1_1_dummy_backend.html#a5938b5d8210d8f57fc09913f0db7b98a">convertPathRelativeToDmapToAbs</a>(parameters[<span class="stringliteral">&quot;map&quot;</span>]);</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">     * Now we have all parameters for the constructor. We just have to create a</span></div><div class="line"><span class="comment">     * shared pointer of the CustomBackend with it.</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keywordflow">return</span> boost::make_shared&lt;CustomBackend&gt;(absolutePath);</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="comment">/*</span></div><div class="line"><span class="comment">   * The task of the BackendRegister is to call the function which tells the</span></div><div class="line"><span class="comment">   * factory about the new type of backend. This is happening in the constructor</span></div><div class="line"><span class="comment">   * of the class, so you just have to create an instance of the class and the</span></div><div class="line"><span class="comment">   * code is executed.</span></div><div class="line"><span class="comment">   */</span></div><div class="line">  <span class="keyword">struct </span>BackendRegisterer {</div><div class="line">    <a class="code" href="struct_custom_backend_1_1_backend_registerer.html#a31bb7bc390448fa5fdfc3e589c078b22">BackendRegisterer</a>() {</div><div class="line">      <span class="comment">/*</span></div><div class="line"><span class="comment">       * The first parameter is the backend type string. It is the name by which</span></div><div class="line"><span class="comment">       * the factory knows which type of backend to create. The name has to be</span></div><div class="line"><span class="comment">       * unique. It shows up in the ChimeraTK device descriptor, in this case</span></div><div class="line"><span class="comment">       * (CUSTOM?map=example.map)</span></div><div class="line"><span class="comment">       * (example.map is the parameter which is passed on to createInstance, see</span></div><div class="line"><span class="comment">       * above)</span></div><div class="line"><span class="comment">       *</span></div><div class="line"><span class="comment">       * The second parameter is the pointer to the createInstance function.</span></div><div class="line"><span class="comment">       * The factory stores this pointer together with the type name and call</span></div><div class="line"><span class="comment">       * the functions when this type if backed needs to be created.</span></div><div class="line"><span class="comment">       */</span></div><div class="line">      <a class="code" href="class_chimera_t_k_1_1_backend_factory.html#a1176b9ab5e2ef7a1b8aa4a4aaaeb924e">ChimeraTK::BackendFactory::getInstance</a>().<a class="code" href="class_chimera_t_k_1_1_backend_factory.html#a6eeda70f92759cf25e039bf585f1b6f8">registerBackendType</a>(<span class="stringliteral">&quot;CUSTOM&quot;</span>, &amp;<a class="code" href="class_custom_backend.html#ad91973dd7ec0803f9bc7ed0b552631db">CustomBackend::createInstance</a>);</div><div class="line">    }</div><div class="line">  };</div><div class="line">};</div><div class="line"></div><div class="line"><span class="comment">// We have one global instance if the BackendRegisterer. Whenever the library</span></div><div class="line"><span class="comment">// containing this backend is loaded, this object is instantiated. As the</span></div><div class="line"><span class="comment">// constructor of this class is registering the device, the backend is</span></div><div class="line"><span class="comment">// automatically known to the factory when the library is loaded.</span></div><div class="line"><span class="keyword">static</span> <a class="code" href="struct_custom_backend_1_1_backend_registerer.html">CustomBackend::BackendRegisterer</a> gCustomBackendRegisterer;</div></div><!-- fragment --><p>Next topic: <a class="el" href="dmap.html">Device Mapping</a> </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Thu Oct 21 2021 03:53:21 for ChimeraTK-DeviceAccess by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
