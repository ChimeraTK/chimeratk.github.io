<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ChimeraTK-DeviceAccess: Using and creating custom backends</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="ChimeraTK_Logo_whitebg.png"/></td>
  <td id="projectalign">
   <div id="projectname">ChimeraTK-DeviceAccess<span id="projectnumber">&#160;03.20.00</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('custom_backends.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Using and creating custom backends</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="writing_dummies"></a>
Writing Dummies: Extending the DummyBackend</h1>
<p>Extending the DummyBackend might be useful for writing simple automated tests. For more complicated tests, in particular those needing to simulate physical behaviour, it is recommended to use the VirtualLab library.</p>
<h1><a class="anchor" id="plugin_mechanism"></a>
The Plugin Mechanism</h1>
<p>Custom backends are provided as shared libraries. There is a plugin mechanism which registers the backend with the backend factory when the library is loaded, no matter whether it has been linked at compile time or is dynamically loaded at run time. The latter allows load all kinds of backends in generic applications QtHardMon or the DeviceAccess python bindings, although they have not explicitly been linked against those backends at compile time.</p>
<h2><a class="anchor" id="linking_backends"></a>
Linking custom backends at compile time (recommended)</h2>
<p>As backends have to be compiled against the same DeviceAccess version as the application it is used in, it is recommended to link them in at compile time if it is already known that it will be needed. An application that is designed to read data from a particular DOOCS server for instance should be directly linked with the DOOCS backend.</p>
<h2><a class="anchor" id="loading_backends"></a>
Loading custom backends at run time</h2>
<p>Custom backends are loaded via the dmap file using the <code>@LOADLIB</code> keyword, followed by the full path to the .so file with the backend. Use the symlink that ends on <code></code>.so, not the ones with a version number.</p>
<pre class="fragment">@LOAD_LIB /path/to/your/lib/libCustomBackend.so

MY_CUSTOM_DEVICE (CUSTOM?map=my_device.map)
</pre><p>Example dmap file from the custom backend registration example (see examples/custom_backend_registration in your build directory).</p>
<p>To ensure binary compatibility of the loaded backed, the application and the backend must compiled against the same version of DeviceAccess. This cannot be done by the DeviceAccess library as it is only one component. There is a scheme how to create Debian packages in a way that all dynamically used backends are updated if the the using application is updated, and vice versa (see <a class="el" href="custom_backends.html#backend_packaging_scheme">Debian packaging scheme for external backends</a>). It should be applicable to other package managers as well (untested).</p>
<h2><a class="anchor" id="writing_backends"></a>
Writing your own backed</h2>
<p>The backend has to fulfil a few requirements for the plugin mechanism to work.</p>
<ul>
<li>The backend has to provide a createInstance() function which can be given to the BackendFactory. Like this the factory can create the backend without knowing the details how to call the specific constructor. </li>
<li>The backend has to be registered with the factory. This should automatically happen when the library is loaded. </li>
<li>The library should be loadable at run time, not only at link time. This requires to check that the backend has been compiled with the the correct DeviceAccess version.</li>
</ul>
<p>The <a class="el" href="class_custom_backend.html">CustomBackend</a> example shows how to implement those three steps of the plugin mechanism. </p><div class="fragment"><div class="line"><span class="comment">// SPDX-FileCopyrightText: Deutsches Elektronen-Synchrotron DESY, MSK, ChimeraTK Project &lt;chimeratk-support@desy.de&gt;</span></div>
<div class="line"><span class="comment">// SPDX-License-Identifier: LGPL-3.0-or-later</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;ChimeraTK/BackendFactory.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;ChimeraTK/DeviceAccessVersion.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;ChimeraTK/DummyBackend.h&gt;</span> <span class="comment">// Would probably be DeviceBackendImpl or NumericAddressedBackend in a real application</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;boost/make_shared.hpp&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * A custom backend which is registered to the factory.</span></div>
<div class="line"><span class="comment"> * This example only shows how to register a new type of backend to the factory.</span></div>
<div class="line"><span class="comment"> * It does not show how to write a new backend. We are lazy and derrive from</span></div>
<div class="line"><span class="comment"> * DummyBackend to have a fully working backend. In a real example you would</span></div>
<div class="line"><span class="comment"> * either derrive from DeviceBackendImpl or NumericAddressedBackend, unless you</span></div>
<div class="line"><span class="comment"> * want to write a custom dummy for testing.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Custom backends are always created as a shared library which can be loaded at</span></div>
<div class="line"><span class="comment"> * run time.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keyword">class </span><a class="code hl_class" href="class_custom_backend.html">CustomBackend</a> : <span class="keyword">public</span> <a class="code hl_class" href="class_chimera_t_k_1_1_dummy_backend.html">ChimeraTK::DummyBackend</a> {</div>
<div class="line"> <span class="keyword">public</span>:</div>
<div class="line">  <span class="comment">// C++11 shorthand syntax that we want a constructor with the same parameters</span></div>
<div class="line">  <span class="comment">// as the parent class.</span></div>
<div class="line">  <span class="keyword">using </span><a class="code hl_function" href="class_chimera_t_k_1_1_dummy_backend.html#a569a3484da2cce7f6e0b8dd5da572587">ChimeraTK::DummyBackend::DummyBackend</a>;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/*</span></div>
<div class="line"><span class="comment">   * You have to implement a static function createInstance() with this exact</span></div>
<div class="line"><span class="comment">   * signature. This function is later given to the BackendFactory to create</span></div>
<div class="line"><span class="comment">   * this type of backend when it is requested.</span></div>
<div class="line"><span class="comment">   */</span></div>
<div class="line">  <span class="keyword">static</span> boost::shared_ptr&lt;ChimeraTK::DeviceBackend&gt; <a class="code hl_function" href="class_custom_backend.html#a0e1332e58594e2f5bae9c19c06367bba">createInstance</a>(</div>
<div class="line">      std::string <span class="comment">/*address*/</span>, std::map&lt;std::string, std::string&gt; parameters) {</div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * Inside createInstance the parameters are interpreted and passed on to the</span></div>
<div class="line"><span class="comment">     * constructor. Like this the backend constructor can have arbitrary</span></div>
<div class="line"><span class="comment">     parameters</span></div>
<div class="line"><span class="comment">     * while the factory can always call a function with the same signature.</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">     * In this example we have to convert the &quot;map&quot; parameter to an absolute</span></div>
<div class="line"><span class="comment">     path</span></div>
<div class="line"><span class="comment">     * (there is already a function for it in the DummyBackend parent class),</span></div>
<div class="line"><span class="comment">     * and pass it on to the constructor, which has the same signature as</span></div>
<div class="line"><span class="comment">     DummyBackend</span></div>
<div class="line"><span class="comment">     * (see &#39;using&#39; clause above).</span></div>
<div class="line"><span class="comment">     *</span></div>
<div class="line"><span class="comment">     * This part will vary, depending on the requirements of the particular</span></div>
<div class="line"><span class="comment">     backend.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    std::string absolutePath = <a class="code hl_function" href="class_chimera_t_k_1_1_dummy_backend.html#a5938b5d8210d8f57fc09913f0db7b98a">convertPathRelativeToDmapToAbs</a>(parameters[<span class="stringliteral">&quot;map&quot;</span>]);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * Now we have all parameters for the constructor. We just have to create a</span></div>
<div class="line"><span class="comment">     * shared pointer of the CustomBackend with it.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    <span class="keywordflow">return</span> boost::make_shared&lt;CustomBackend&gt;(absolutePath);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/*</span></div>
<div class="line"><span class="comment">   * The task of the BackendRegister is to call the function which tells the</span></div>
<div class="line"><span class="comment">   * factory about the new type of backend. This is happening in the constructor</span></div>
<div class="line"><span class="comment">   * of the class, so you just have to create an instance of the class and the</span></div>
<div class="line"><span class="comment">   * code is executed.</span></div>
<div class="line"><span class="comment">   */</span></div>
<div class="line">  <span class="keyword">struct </span><a class="code hl_class" href="class_backend_registerer.html">BackendRegisterer</a> {</div>
<div class="line">    <a class="code hl_function" href="struct_custom_backend_1_1_backend_registerer.html#a31bb7bc390448fa5fdfc3e589c078b22">BackendRegisterer</a>() {</div>
<div class="line">      <span class="comment">/*</span></div>
<div class="line"><span class="comment">       * The first parameter is the backend type string. It is the name by which</span></div>
<div class="line"><span class="comment">       * the factory knows which type of backend to create. The name has to be</span></div>
<div class="line"><span class="comment">       * unique. It shows up in the ChimeraTK device descriptor, in this case</span></div>
<div class="line"><span class="comment">       * (CUSTOM?map=example.map)</span></div>
<div class="line"><span class="comment">       * (example.map is the parameter which is passed on to createInstance, see</span></div>
<div class="line"><span class="comment">       * above)</span></div>
<div class="line"><span class="comment">       *</span></div>
<div class="line"><span class="comment">       * The second parameter is the pointer to the createInstance function.</span></div>
<div class="line"><span class="comment">       * The factory stores this pointer together with the type name and call</span></div>
<div class="line"><span class="comment">       * the functions when this type if backed needs to be created.</span></div>
<div class="line"><span class="comment">       */</span></div>
<div class="line">      <a class="code hl_function" href="class_chimera_t_k_1_1_backend_factory.html#a1176b9ab5e2ef7a1b8aa4a4aaaeb924e">ChimeraTK::BackendFactory::getInstance</a>().<a class="code hl_function" href="class_chimera_t_k_1_1_backend_factory.html#a1492b4d8cb3313233154abb709255cfe">registerBackendType</a>(<span class="stringliteral">&quot;CUSTOM&quot;</span>, &amp;<a class="code hl_function" href="class_custom_backend.html#a0e1332e58594e2f5bae9c19c06367bba">CustomBackend::createInstance</a>);</div>
<div class="line">    }</div>
<div class="line">  };</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">// We have one global instance if the BackendRegisterer. Whenever the library</span></div>
<div class="line"><span class="comment">// containing this backend is loaded, this object is instantiated. As the</span></div>
<div class="line"><span class="comment">// constructor of this class is registering the device, the backend is</span></div>
<div class="line"><span class="comment">// automatically known to the factory when the library is loaded.</span></div>
<div class="line"><span class="keyword">static</span> <a class="code hl_struct" href="struct_custom_backend_1_1_backend_registerer.html">CustomBackend::BackendRegisterer</a> gCustomBackendRegisterer;</div>
<div class="ttc" id="aclass_backend_registerer_html"><div class="ttname"><a href="class_backend_registerer.html">BackendRegisterer</a></div><div class="ttdef"><b>Definition</b> <a href="test_generic_muxed_interrupt_distributor_8cpp_source.html#l00070">testGenericMuxedInterruptDistributor.cpp:70</a></div></div>
<div class="ttc" id="aclass_chimera_t_k_1_1_backend_factory_html_a1176b9ab5e2ef7a1b8aa4a4aaaeb924e"><div class="ttname"><a href="class_chimera_t_k_1_1_backend_factory.html#a1176b9ab5e2ef7a1b8aa4a4aaaeb924e">ChimeraTK::BackendFactory::getInstance</a></div><div class="ttdeci">static BackendFactory &amp; getInstance()</div><div class="ttdoc">Static function to get an instance of factory.</div><div class="ttdef"><b>Definition</b> <a href="_backend_factory_8cc_source.html#l00191">BackendFactory.cc:191</a></div></div>
<div class="ttc" id="aclass_chimera_t_k_1_1_backend_factory_html_a1492b4d8cb3313233154abb709255cfe"><div class="ttname"><a href="class_chimera_t_k_1_1_backend_factory.html#a1492b4d8cb3313233154abb709255cfe">ChimeraTK::BackendFactory::registerBackendType</a></div><div class="ttdeci">void registerBackendType(const std::string &amp;backendType, boost::shared_ptr&lt; DeviceBackend &gt;(*creatorFunction)(std::string address, std::map&lt; std::string, std::string &gt; parameters), const std::vector&lt; std::string &gt; &amp;sdmParameterNames={}, const std::string &amp;deviceAccessVersion=CHIMERATK_DEVICEACCESS_VERSION)</div><div class="ttdoc">Register a backend by the name backendType with the given creatorFunction.</div><div class="ttdef"><b>Definition</b> <a href="_backend_factory_8cc_source.html#l00045">BackendFactory.cc:45</a></div></div>
<div class="ttc" id="aclass_chimera_t_k_1_1_dummy_backend_html"><div class="ttname"><a href="class_chimera_t_k_1_1_dummy_backend.html">ChimeraTK::DummyBackend</a></div><div class="ttdoc">The dummy device opens a mapping file instead of a device, and implements all registers defined in th...</div><div class="ttdef"><b>Definition</b> <a href="_dummy_backend_8h_source.html#l00045">DummyBackend.h:45</a></div></div>
<div class="ttc" id="aclass_chimera_t_k_1_1_dummy_backend_html_a569a3484da2cce7f6e0b8dd5da572587"><div class="ttname"><a href="class_chimera_t_k_1_1_dummy_backend.html#a569a3484da2cce7f6e0b8dd5da572587">ChimeraTK::DummyBackend::DummyBackend</a></div><div class="ttdeci">DummyBackend(const std::string &amp;mapFileName, const std::string &amp;dataConsistencyKeyDescriptor=&quot;&quot;)</div><div class="ttdef"><b>Definition</b> <a href="_dummy_backend_8cc_source.html#l00017">DummyBackend.cc:17</a></div></div>
<div class="ttc" id="aclass_chimera_t_k_1_1_dummy_backend_html_a5938b5d8210d8f57fc09913f0db7b98a"><div class="ttname"><a href="class_chimera_t_k_1_1_dummy_backend.html#a5938b5d8210d8f57fc09913f0db7b98a">ChimeraTK::DummyBackend::convertPathRelativeToDmapToAbs</a></div><div class="ttdeci">static std::string convertPathRelativeToDmapToAbs(std::string const &amp;mapfileName)</div><div class="ttdef"><b>Definition</b> <a href="_dummy_backend_8cc_source.html#l00176">DummyBackend.cc:176</a></div></div>
<div class="ttc" id="aclass_custom_backend_html"><div class="ttname"><a href="class_custom_backend.html">CustomBackend</a></div><div class="ttdef"><b>Definition</b> <a href="_custom_backend_8cc_source.html#l00021">CustomBackend.cc:21</a></div></div>
<div class="ttc" id="aclass_custom_backend_html_a0e1332e58594e2f5bae9c19c06367bba"><div class="ttname"><a href="class_custom_backend.html#a0e1332e58594e2f5bae9c19c06367bba">CustomBackend::createInstance</a></div><div class="ttdeci">static boost::shared_ptr&lt; ChimeraTK::DeviceBackend &gt; createInstance(std::string, std::map&lt; std::string, std::string &gt; parameters)</div><div class="ttdef"><b>Definition</b> <a href="_custom_backend_8cc_source.html#l00032">CustomBackend.cc:32</a></div></div>
<div class="ttc" id="astruct_custom_backend_1_1_backend_registerer_html"><div class="ttname"><a href="struct_custom_backend_1_1_backend_registerer.html">CustomBackend::BackendRegisterer</a></div><div class="ttdef"><b>Definition</b> <a href="_custom_backend_8cc_source.html#l00065">CustomBackend.cc:65</a></div></div>
<div class="ttc" id="astruct_custom_backend_1_1_backend_registerer_html_a31bb7bc390448fa5fdfc3e589c078b22"><div class="ttname"><a href="struct_custom_backend_1_1_backend_registerer.html#a31bb7bc390448fa5fdfc3e589c078b22">CustomBackend::BackendRegisterer::BackendRegisterer</a></div><div class="ttdeci">BackendRegisterer()</div><div class="ttdef"><b>Definition</b> <a href="_custom_backend_8cc_source.html#l00066">CustomBackend.cc:66</a></div></div>
</div><!-- fragment --><h2><a class="anchor" id="backend_packaging_scheme"></a>
Debian packaging scheme for external backends</h2>
<p>In the <a class="el" href="namespace_chimera_t_k.html">ChimeraTK</a> Debian packaging scheme, the libraries themselves contain the build number as part of the minor version number (e.g. /usr/lib/libChimeraTK-DeviceAccess.so.03.07focal1.01) and the package name itself contains the major and minor version number (e.g. libchimeratk-deviceaccess03-07-focal1). This allows to have several binary incompatible version of the same library to be installed at the same time, and each executable to unambiguously link against the correct version.</p>
<p>To get a consistent set of libraries at compile time, the -dev packages do not have a version number itself, but depend on the current versions of the dependencies. For instance, the package <code>libchimeratk-device-access-dev</code> in version 03.07focal1.01 depends on <code>libchimeratk-cppext-dev (&gt;= 01.04focal1), libchimeratk-cppext-dev (&lt;&lt; 01.04focal2)</code>. Like this, all -dev packages are consistently upgraded to a new version if one of them is upgraded, while the linker is searching for the .so-file without version number, which is a symlink to the versioned file. The Debian packaging scripts (<a href="https://github.com/ChimeraTK/DebianPackagingScripts">https://github.com/ChimeraTK/DebianPackagingScripts</a>) ensure that all packages are re-build if a dependency changes.</p>
<p>If the generic applications QtHardMon and DeviceAccess python bindings as well as the loadable backend packages would depend on lib-chimeratk-deviceaccess-dev, this would guarantee that /usr/lib/libMyCustomBackend.so could always be loaded at run time, without having to know the exact version number. The drawback of this solution is to always install the headers and the whole chain of build tools on the target machines, which is not wanted.</p>
<p>The mechanism to resolve this is based on two extra packages:</p>
<ul>
<li>libchimeratk-deviceaccess (without version number in the package name) is an empty meta package which acts as a reference anchor for the generic applications and the backends. </li>
<li>libchimeratk-deviceaccess-mycustombackend (without version number in the package name)</li>
</ul>
<p>The symlink /usr/lib/libMyCustomBackend.so has been moved out of the -dev package into the new package libchimeratk-deviceaccess-mycustombackend, and the -dev package depends on that new package. This custom backend package without version and the generic application depends on the correct version of libchimeratk-deviceaccess. If now either a backend or a generic application is upgraded on the target host, this will upgrade the required version of libchimeratk-deviceaccess as its dependency, which in turn will upgrade all packages that depend on it, i.e. all other generic applications and backends.</p>
<h3><a class="anchor" id="backend_packaging_usage"></a>
Usage in the packaging scripts</h3>
<ul>
<li>Instead of having a <code>dev</code> and a <code>lib</code> package, loadable backends specify the two packages <code>dev-noheader-dynload</code> and <code>lib</code> in the <code>Has-packages</code> section of the DebiianBuildVersions CONFIG file. <div class="fragment"><div class="line">Has-packages: dev-noheader-dynload lib</div>
</div><!-- fragment --> </li>
<li>Generic executables that want to use dynamic backend loading define <code>Use-dynload</code> in the CONFIG file for the particular package (typically for the <code>bin</code> package) <div class="fragment"><div class="line">Has-packages: bin</div>
<div class="line">Use-dynload: bin</div>
</div><!-- fragment --></li>
</ul>
<p>Next topic: <a class="el" href="dmap.html">Device Mapping</a> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
